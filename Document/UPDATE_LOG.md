# 更新日志 (Update Log)

## 2025年12月 - Windows路径兼容性修复

### 修复的问题

**Windows路径识别错误（重要修复）**
- ✅ 修复了Windows用户输入路径时反斜杠`\`导致FFmpeg识别错误的问题
- ✅ 现在支持直接使用Windows原生路径格式（如 `C:\Videos\test.mp4`）
- ✅ 程序会自动将反斜杠转换为正斜杠，FFmpeg在所有平台都兼容
- ✅ 特殊处理字幕滤镜路径，正确转义Windows盘符冒号

### 技术改进

**新增函数（app.py）:**

1. `normalize_path(path)` - 路径规范化
   ```python
   # Windows路径: C:\Videos\test.mp4
   # 转换后: C:/Videos/test.mp4
   ```

2. `escape_path_for_subtitle_filter(path)` - 字幕路径转义
   ```python
   # Windows字幕: C:\Subtitles\test.srt
   # 在Windows平台转义为: C\:/Subtitles/test.srt
   # 在其他平台: C:/Subtitles/test.srt
   ```

### 兼容性测试

已测试以下路径格式：
- ✅ Windows标准路径：`C:\Users\用户名\Videos\test.mp4`
- ✅ 包含空格：`D:\My Videos\Episode 01.mp4`
- ✅ 包含中文：`E:\视频文件\第一集.mp4`
- ✅ UNC网络路径：`\\Server\Share\video.mp4`
- ✅ macOS/Linux路径：`/home/user/videos/test.mp4`（保持不变）
- ✅ 相对路径：`./relative/path/video.mp4`（保持不变）

### 向后兼容性

此修复完全向后兼容：
- macOS用户：不受影响
- Linux用户：不受影响
- 已使用正斜杠的Windows用户：不受影响
- 新Windows用户：可以直接使用反斜杠路径

### 相关文档

详细说明请查看：[WINDOWS_PATH_FIX.md](WINDOWS_PATH_FIX.md)

---

## 2024年更新 - Bug修复和功能增强

### 修复的问题

1. **独立路径验证**
   - 修复了之前需要同时填写两个路径才能验证的问题
   - 现在每个文件夹路径可以独立验证
   - 每个路径都有独立的验证按钮和状态提示

2. **按钮状态管理**
   - 输入路径后，验证按钮从灰色变为可用状态
   - 只有所有路径都验证通过后，"开始批量合成"按钮才会变为可用
   - 处理过程中显示"终止任务"按钮

3. **路径格式验证**
   - 添加了路径格式的前端验证
   - 自动检测并提示以下问题：
     - 路径前后有空格
     - 路径包含引号
     - 路径有连续空格
     - 路径格式不正确
   - 支持 macOS/Linux 和 Windows 路径格式

### 新增功能

1. **实时输入验证**
   - 输入路径时实时检查格式
   - 使用颜色标识：
     - 绿色边框：验证通过
     - 红色边框：验证失败
     - 橙色提示：格式警告

2. **详细的验证消息**
   - 每个输入框下方显示验证状态
   - 成功提示（绿色）：✓ 找到 X 个视频文件
   - 错误提示（红色）：✗ 路径不存在
   - 警告提示（橙色）：⚠ 路径格式可能有误

3. **终止任务功能**
   - 新增"终止任务"按钮
   - 可以随时终止正在进行的任务
   - 已完成的视频不受影响
   - 终止当前正在处理的ffmpeg进程

### 技术改进

#### 后端 (app.py)
- 新增 `/api/validate_folder` 接口，支持单独验证文件夹
- 添加 `stop_requested` 标志和进程终止逻辑
- 使用 `Popen` 替代 `run` 以支持进程终止

#### 前端 (index.html)
- 添加 `validatePathFormat()` 函数进行路径格式验证
- 添加 `handlePathInput()` 函数处理实时输入
- 添加 `validationState` 对象跟踪验证状态
- 改进 UI 样式，添加输入框状态提示

### 使用说明

1. **填写路径**
   - 在输入框中填写完整路径
   - 路径格式：
     - macOS/Linux: `/Users/username/videos`
     - Windows: `C:\Users\username\videos`

2. **验证路径**
   - 点击"验证"按钮检查路径
   - 观察输入框颜色和下方提示信息
   - 绿色表示验证通过

3. **开始合成**
   - 确保三个路径都验证通过（显示绿色）
   - "开始批量合成"按钮会自动变为可用
   - 点击开始处理

4. **终止任务**
   - 如需终止，点击"终止任务"按钮
   - 已完成的视频会保留
   - 可以重新开始处理

### 常见问题解决

**Q: 验证按钮是灰色的？**
A: 请先在输入框中填写路径，按钮会自动变为可用。

**Q: 显示路径格式错误？**
A: 检查路径是否包含空格、引号或其他特殊字符，确保路径格式正确。

**Q: 开始按钮无法点击？**
A: 需要三个路径都验证通过（显示绿色✓），按钮才会变为可用。

**Q: 如何停止正在运行的任务？**
A: 点击"终止任务"按钮，系统会停止处理后续视频。
