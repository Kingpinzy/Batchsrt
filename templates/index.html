<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡è§†é¢‘å­—å¹•åˆæˆå·¥å…·</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #000000;
            --primary-hover: #333333;
            --bg-body: #f5f5f5;
            --bg-card: #ffffff;
            --text-main: #000000;
            --text-secondary: #666666;
            --border: #e0e0e0;
            --success: #000000;
            --error: #000000;
            --warning: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 1600px;
            background: var(--bg-card);
            border-radius: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
        }

        .header {
            background: white;
            padding: 30px 40px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 400;
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å·¦ä¾§é…ç½®é¢æ¿ */
        .left-panel {
            flex: 1;
            min-width: 500px;
            max-width: 50%;
            padding: 30px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            background: #fafafa;
        }

        /* å³ä¾§æ—¥å¿—é¢æ¿ */
        .right-panel {
            flex: 1;
            min-width: 500px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        .form-section {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-main);
            font-size: 14px;
        }

        .input-group {
            display: flex;
            gap: 12px;
            position: relative;
        }

        .form-group input[type="text"] {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            color: var(--text-main);
            background: #f8fafc;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
        }

        .form-group input[type="text"].valid {
            border-color: #000000;
            background-color: #f5f5f5;
        }

        .form-group input[type="text"].invalid {
            border-color: #666666;
            background-color: #f5f5f5;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
            font-size: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--text-main);
            border: 1px solid var(--border);
            min-width: 80px;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #999999;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-danger {
            background: #333333;
            color: white;
            width: 100%;
            font-size: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .btn-danger:hover:not(:disabled) {
            background: #000000;
            transform: translateY(-1px);
        }

        .validation-message {
            font-size: 12px;
            margin-top: 4px;
            min-height: 18px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .validation-message.success { color: #000000; }
        .validation-message.error { color: #000000; }
        .validation-message.warning { color: #666666; }

        .language-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .tag {
            padding: 4px 10px;
            background: #e8e8e8;
            color: var(--text-main);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* GPU Section Styling */
        .gpu-section {
            background: #f8f8f8;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            transition: all 0.2s ease;
        }

        .gpu-section:hover {
            border-color: #cbd5e1;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--border);
            appearance: none;
            background: white;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .checkbox-wrapper input[type="checkbox"]:checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .checkbox-wrapper input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 4px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .gpu-badge {
            padding: 4px 10px;
            background: rgba(0, 179, 77, 1);
            color: white;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 10px;
        }

        .gpu-options {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(0,0,0,0.05);
            animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .gpu-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            color: var(--text-main);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
        }

        .gpu-select:hover {
            border-color: #999999;
        }

        .gpu-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
        }

        .gpu-hint {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* æ»‘å—æ ·å¼ */
        .style-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .style-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .style-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 8px rgba(0, 0, 0, 0.1);
        }

        .style-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .style-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 8px rgba(0, 0, 0, 0.1);
        }

        details summary {
            list-style: none;
        }

        details summary::-webkit-details-marker {
            display: none;
        }

        details[open] summary {
            margin-bottom: 16px;
        }

        .alert {
            padding: 14px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .alert-info {
            background: #f5f5f5;
            color: #000000;
            border: 1px solid #e0e0e0;
        }

        .alert-info ul {
            padding-left: 18px;
            margin-top: 6px;
            color: #333333;
        }

        .alert-info li {
            margin-bottom: 2px;
        }

        /* Log Section */
        .log-section {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .log-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 99px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-idle { background: #f5f5f5; color: var(--text-secondary); }
        .status-processing {
            background: #e8e8e8;
            color: #000000;
            animation: pulse 2s infinite;
        }
        .status-completed { background: #e8e8e8; color: #000000; }
        .status-error { background: #e8e8e8; color: #000000; }

        .progress-bar-container {
            height: 8px;
            background: #e8e8e8;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.4s ease;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .log-box {
            background: #000000;
            color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            flex: 1;
            overflow-y: auto;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
            border: 1px solid #333333;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .log-line {
            margin-bottom: 4px;
            border-left: 3px solid transparent;
            padding-left: 12px;
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 13px;
            border-top: 1px solid var(--border);
            margin-top: 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: #999999;
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        ::-webkit-scrollbar-thumb:hover { background-color: #666666; }
        .log-box::-webkit-scrollbar-thumb { background-color: #666666; }
        .log-box::-webkit-scrollbar-thumb:hover { background-color: #999999; }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
                height: auto;
                min-height: calc(100vh - 80px);
            }

            .content {
                flex-direction: column;
            }

            .left-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .right-panel {
                width: 100%;
                min-height: 500px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .left-panel, .right-panel {
                padding: 20px;
            }

            .input-group {
                flex-direction: column;
            }

            .btn-secondary {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ‰¹é‡è§†é¢‘å­—å¹•åˆæˆå·¥å…·</h1>
            <p>Batch Video Subtitle Merger Tool</p>
        </div>

        <div class="content">
            <!-- å·¦ä¾§ï¼šé…ç½®é¢æ¿ -->
            <div class="left-panel">
                <h3 class="section-title">ğŸ“ é…ç½®å‚æ•°</h3>

                <!-- æ–‡ä»¶å¤¹é€‰æ‹©è¡¨å• -->
                <div class="form-section">
                <div class="form-group">
                    <label>åŸè§†é¢‘æ–‡ä»¶å¤¹</label>
                    <div class="input-group">
                        <input type="text" id="videoFolder" placeholder="/path/to/videos" oninput="handlePathInput('video')">
                        <button id="validateVideoBtn" class="btn btn-secondary" onclick="validateFolder('video')" disabled>éªŒè¯</button>
                    </div>
                    <div id="videoFolderMsg" class="validation-message"></div>
                </div>

                <div class="form-group">
                    <label>å­—å¹•æ–‡ä»¶å¤¹</label>
                    <div class="input-group">
                        <input type="text" id="subtitleFolder" placeholder="/path/to/subtitles" oninput="handlePathInput('subtitle')">
                        <button id="validateSubtitleBtn" class="btn btn-secondary" onclick="validateFolder('subtitle')" disabled>éªŒè¯</button>
                    </div>
                    <div id="subtitleFolderMsg" class="validation-message"></div>
                    <div id="languageContainer" class="language-tags"></div>
                </div>

                <div class="form-group">
                    <label>è¾“å‡ºæ–‡ä»¶å¤¹</label>
                    <div class="input-group">
                        <input type="text" id="outputFolder" placeholder="/path/to/output" oninput="handlePathInput('output')">
                        <button id="validateOutputBtn" class="btn btn-secondary" onclick="validateFolder('output')" disabled>éªŒè¯</button>
                    </div>
                    <div id="outputFolderMsg" class="validation-message"></div>
                </div>
            </div>

            <!-- GPU åŠ é€Ÿæ¨¡å— -->
            <div class="gpu-section">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="useGpu" onchange="toggleGpuOptions()">
                    <span style="font-weight: 600; font-size: 15px; color: var(--text-main);">å¯ç”¨ GPU ç¡¬ä»¶åŠ é€Ÿ</span>
                    <span id="gpuBadge" class="gpu-badge" style="display: none;">æ¨è</span>
                </label>

                <div id="gpuOptions" class="gpu-options" style="display: none;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary);">é€‰æ‹©åŠ é€Ÿè®¾å¤‡</label>
                    <select id="gpuType" class="gpu-select">
                        <option value="auto">âœ¨ è‡ªåŠ¨æ£€æµ‹æœ€ä½³è®¾å¤‡</option>
                    </select>
                    <div class="gpu-hint">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                        </svg>
                        GPU åŠ é€Ÿå¯æ˜¾è‘—æå‡å¤„ç†é€Ÿåº¦ï¼ˆ2-5å€ï¼‰ï¼Œéœ€é…åˆå…¼å®¹é©±åŠ¨
                    </div>
                </div>
            </div>

            <!-- å­—å¹•æ ·å¼é…ç½®æ¨¡å— -->
            <div class="gpu-section">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="useCustomStyle" onchange="toggleStyleOptions()">
                    <span style="font-weight: 600; font-size: 15px; color: var(--text-main);">è‡ªå®šä¹‰å­—å¹•æ ·å¼</span>
                </label>

                <div id="styleOptions" class="gpu-options" style="display: none;">
                    <!-- è§†é¢‘æ¯”ä¾‹é€‰æ‹© -->
                    <div style="margin-bottom: 20px; padding: 12px; background: #f0f0f0; border-radius: 8px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-main);">
                            ğŸ“ è§†é¢‘ç”»é¢æ¯”ä¾‹
                        </label>
                        <select id="videoRatio" class="gpu-select" onchange="handleRatioChange()">
                            <option value="16:9">16:9 æ¨ªå±ï¼ˆå¸¸è§„è§†é¢‘ï¼Œå¦‚ 1920Ã—1080ï¼‰</option>
                            <option value="9:16">9:16 ç«–å±ï¼ˆæ‰‹æœºè§†é¢‘ï¼Œå¦‚ 1080Ã—1920ï¼‰</option>
                            <option value="1:1">1:1 æ–¹å½¢ï¼ˆç¤¾äº¤åª’ä½“ï¼Œå¦‚ 1080Ã—1080ï¼‰</option>
                            <option value="4:3">4:3 æ ‡å‡†ï¼ˆä¼ ç»Ÿè§†é¢‘ï¼Œå¦‚ 1440Ã—1080ï¼‰</option>
                        </select>
                        <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary); line-height: 1.5;">
                            âš ï¸ è¯·æ ¹æ®æ‚¨çš„è§†é¢‘æ¯”ä¾‹é€‰æ‹©ï¼Œé¢„è®¾ä½ç½®ä¼šè‡ªåŠ¨è°ƒæ•´
                        </div>
                    </div>

                    <!-- å­—ä½“å¤§å° -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary);">
                            å­—ä½“å¤§å°: <span id="fontSizeValue" style="color: var(--text-main);">24</span>
                        </label>
                        <input type="range" id="fontSize" class="style-slider" min="5" max="72" value="24" step="1" oninput="updateSliderValue('fontSize')">
                    </div>

                    <!-- åº•éƒ¨è¾¹è· -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary);">
                            å‚ç›´è¾¹è·: <span id="marginVValue" style="color: var(--text-main);">50</span> px
                        </label>
                        <input type="range" id="marginV" class="style-slider" min="0" max="600" value="50" step="10" oninput="updateSliderValue('marginV')">
                        <div style="margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
                            ä»åº•éƒ¨ï¼ˆé»˜è®¤ï¼‰æˆ–é¡¶éƒ¨ï¼ˆé€‰æ‹©é¡¶éƒ¨å¯¹é½æ—¶ï¼‰çš„è·ç¦»
                        </div>
                    </div>

                    <!-- å¯¹é½æ–¹å¼ -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary);">å­—å¹•ä½ç½®</label>
                        <select id="alignment" class="gpu-select" onchange="handleAlignmentChange()">
                            <option value="2">åº•éƒ¨å±…ä¸­ï¼ˆé»˜è®¤ï¼‰</option>
                            <option value="1">å·¦ä¸‹</option>
                            <option value="3">å³ä¸‹</option>
                            <option value="5">å±å¹•ä¸­å¤®</option>
                            <option value="8">é¡¶éƒ¨å±…ä¸­</option>
                            <option value="7">å·¦ä¸Š</option>
                            <option value="9">å³ä¸Š</option>
                        </select>
                    </div>

                    <!-- é«˜çº§é€‰é¡¹ï¼ˆå¯æŠ˜å ï¼‰ -->
                    <details style="margin-top: 16px;">
                        <summary style="cursor: pointer; font-weight: 600; font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">é«˜çº§é€‰é¡¹</summary>

                        <!-- å­—ä½“é…ç½®æ¨¡å¼é€‰æ‹© -->
                        <div style="margin-bottom: 16px; margin-top: 12px; padding: 12px; background: #f0f0f0; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-main);">
                                ğŸ”¤ å­—ä½“é…ç½®æ¨¡å¼
                            </label>
                            <select id="fontMode" class="gpu-select" onchange="handleFontModeChange()">
                                <option value="auto">è‡ªåŠ¨æ˜ å°„ï¼ˆæ¨èï¼‰- æ ¹æ®è¯­ç§è‡ªåŠ¨é€‰æ‹©æœ€ä½³å­—ä½“</option>
                                <option value="name">å­—ä½“åç§° - æ‰‹åŠ¨æŒ‡å®šç³»ç»Ÿå­—ä½“</option>
                                <option value="file">å­—ä½“æ–‡ä»¶ - ä½¿ç”¨fontsç›®å½•ä¸­çš„å­—ä½“æ–‡ä»¶</option>
                            </select>
                            <div id="fontModeHint" style="margin-top: 8px; font-size: 12px; color: var(--text-secondary); line-height: 1.5;">
                                âœ¨ è‡ªåŠ¨æ¨¡å¼ä¼šä¸ºæ¯ç§è¯­è¨€é€‰æ‹©æœ€åˆé€‚çš„å­—ä½“ï¼Œè§£å†³å°è¯­ç§å­—ä½“ä¸¢å¤±é—®é¢˜
                            </div>
                        </div>

                        <!-- å­—ä½“åç§°è¾“å…¥ï¼ˆå­—ä½“åç§°æ¨¡å¼ï¼‰ -->
                        <div id="fontNameSection" style="margin-bottom: 16px; display: none;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary);">å­—ä½“åç§°</label>
                            <input type="text" id="fontName" class="gpu-select" placeholder="ä¾‹å¦‚: Arial, Microsoft YaHei, Noto Sans Arabic" style="padding: 10px 16px;">
                            <div style="margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
                                è¾“å…¥å·²å®‰è£…çš„ç³»ç»Ÿå­—ä½“åç§°ï¼Œæ”¯æŒå¤šå­—ä½“å›é€€ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰
                            </div>
                        </div>

                        <!-- å­—ä½“æ–‡ä»¶é€‰æ‹©ï¼ˆå­—ä½“æ–‡ä»¶æ¨¡å¼ï¼‰ -->
                        <div id="fontFileSection" style="margin-bottom: 16px; display: none;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary);">é€‰æ‹©å­—ä½“æ–‡ä»¶</label>
                            <select id="fontFile" class="gpu-select">
                                <option value="">ä»fontsç›®å½•é€‰æ‹©...</option>
                            </select>
                            <button class="btn btn-secondary" onclick="refreshFontFiles()" style="margin-top: 8px; width: 100%;">
                                ğŸ”„ åˆ·æ–°å­—ä½“åˆ—è¡¨
                            </button>
                            <div id="fontFileHint" style="margin-top: 8px; font-size: 11px; color: var(--text-secondary);">

                            </div>
                        </div>

                        <!-- è½®å»“ç²—ç»† -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary);">
                                è½®å»“ç²—ç»†: <span id="outlineValue" style="color: var(--text-main);">0</span>
                            </label>
                            <input type="range" id="outline" class="style-slider" min="0" max="5" value="0" step="1" oninput="updateSliderValue('outline')">
                            <div style="margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
                                è®¾ä¸º 0 = æ— é»‘è¾¹ï¼Œè®¾ä¸º 2-3 = æ¸…æ™°å¯è§ï¼ˆæ¨èå¤æ‚èƒŒæ™¯ä½¿ç”¨ï¼‰
                            </div>
                        </div>

                        <!-- é˜´å½±æ·±åº¦ -->
                        <div style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary);">
                                é˜´å½±æ·±åº¦: <span id="shadowValue" style="color: var(--text-main);">0</span>
                            </label>
                            <input type="range" id="shadow" class="style-slider" min="0" max="5" value="0" step="1" oninput="updateSliderValue('shadow')">
                            <div style="margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
                                è®¾ä¸º 0 = æ— é˜´å½±ï¼Œè®¾ä¸º 1-2 = å¢åŠ ç«‹ä½“æ„Ÿ
                            </div>
                        </div>
                    </details>

                    <div class="gpu-hint" style="margin-top: 12px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        å­—å¹•æ ·å¼ä¼šåº”ç”¨åˆ°æ‰€æœ‰è¾“å‡ºè§†é¢‘ï¼Œç•™ç©ºé€‰é¡¹å°†ä½¿ç”¨åŸå­—å¹•æ–‡ä»¶æ ·å¼
                    </div>
                </div>
            </div>

            <!-- ä½¿ç”¨è¯´æ˜ -->
            <div class="alert alert-info">
                <strong>ğŸ’¡ ä½¿ç”¨æŒ‡å—</strong>
                <ul>
                    <li>åˆ†åˆ«é€‰æ‹©è§†é¢‘ã€å­—å¹•å’Œè¾“å‡ºæ–‡ä»¶å¤¹ï¼Œå¹¶ç‚¹å‡»"éªŒè¯"</li>
                    <li>å­—å¹•æ–‡ä»¶å‘½åéœ€æ ¼å¼ç»Ÿä¸€ï¼šè§†é¢‘å_è¯­ç§.srtï¼ˆä¾‹ï¼š001_AR.srtï¼‰</li>
                    <li>æ‰€æœ‰è·¯å¾„éªŒè¯é€šè¿‡åï¼Œåº•éƒ¨æŒ‰é’®å°†äº®èµ·</li>
                </ul>
            </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div style="margin-top: 24px;">
                    <button id="startBtn" class="btn btn-primary" onclick="startMerge()" disabled>
                        å¼€å§‹æ‰¹é‡åˆæˆ
                    </button>
                    <button id="stopBtn" class="btn btn-danger" onclick="stopMerge()" style="display:none;">
                        ç»ˆæ­¢ä»»åŠ¡
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šè¿›åº¦ç›‘æ§ -->
            <div class="right-panel">
                <div class="log-header">
                    <h3>ğŸ“Š å®æ—¶è¿›åº¦</h3>
                    <div id="statusBadge" class="status-badge status-idle">å¾…æœº</div>
                </div>

                <div id="currentTask" style="margin-bottom: 12px; font-size: 14px; color: var(--text-secondary); display: none;">
                    å½“å‰ä»»åŠ¡ï¼š<span id="currentTaskText" style="color: var(--text-main); font-weight: 600;">...</span>
                </div>

                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
                </div>

                <div class="progress-info">
                    <span id="progressBarText">0%</span>
                    <span id="progressText">0 / 0</span>
                </div>

                <div id="logBox" class="log-box"></div>
            </div>
        </div>
    </div>

    <script>
        let statusCheckInterval = null;
        let validationState = {
            video: false,
            subtitle: false,
            output: false
        };
        let gpuInfo = null;

        // é¡µé¢åŠ è½½
        window.addEventListener('load', async () => {
            addLog('âœ¨ ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…ä»»åŠ¡é…ç½®...');
            await detectGPU();
            await refreshFontFiles();
        });

        // é¡µé¢å…³é—­æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (statusCheckInterval) clearInterval(statusCheckInterval);
        });

        // GPU æ£€æµ‹
        async function detectGPU() {
            try {
                const response = await fetch('/api/detect_gpu');
                gpuInfo = await response.json();

                const gpuTypeSelect = document.getElementById('gpuType');
                gpuTypeSelect.innerHTML = '';

                gpuInfo.gpu_types.forEach(gpu => {
                    const option = document.createElement('option');
                    option.value = gpu.value;
                    option.textContent = `${gpu.icon} ${gpu.label}`;
                    gpuTypeSelect.appendChild(option);
                });

                if (gpuInfo.has_gpu) {
                    document.getElementById('gpuBadge').style.display = 'inline-flex';
                    addLog(`âœ… æ£€æµ‹åˆ° GPU åŠ é€Ÿè®¾å¤‡: ${gpuInfo.recommended.toUpperCase()}`);
                } else {
                    addLog('â„¹ï¸ æœªæ£€æµ‹åˆ°ç‹¬ç«‹æ˜¾å¡ï¼Œå°†ä½¿ç”¨ CPU è¿›è¡Œå¤„ç†');
                }
            } catch (error) {
                console.error('GPUæ£€æµ‹å¤±è´¥:', error);
                addLog('âš ï¸ GPU ç¯å¢ƒæ£€æµ‹å¤±è´¥ï¼Œé»˜è®¤å›é€€è‡³ CPU æ¨¡å¼');
            }
        }

        function toggleGpuOptions() {
            const useGpu = document.getElementById('useGpu').checked;
            const gpuOptions = document.getElementById('gpuOptions');

            if (useGpu) {
                gpuOptions.style.display = 'block';
                addLog('âš¡ å·²å¯ç”¨ GPU ç¡¬ä»¶åŠ é€Ÿæ¨¡å¼');
            } else {
                gpuOptions.style.display = 'none';
                addLog('ğŸ’» å·²åˆ‡æ¢è‡³æ ‡å‡† CPU å¤„ç†æ¨¡å¼');
            }
        }

        function toggleStyleOptions() {
            const useCustomStyle = document.getElementById('useCustomStyle').checked;
            const styleOptions = document.getElementById('styleOptions');

            if (useCustomStyle) {
                styleOptions.style.display = 'block';
                addLog('ğŸ¨ å·²å¯ç”¨è‡ªå®šä¹‰å­—å¹•æ ·å¼');
            } else {
                styleOptions.style.display = 'none';
                addLog('ğŸ“ å°†ä½¿ç”¨åŸå­—å¹•æ–‡ä»¶æ ·å¼');
            }
        }

        function updateSliderValue(sliderId) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(sliderId + 'Value');
            valueDisplay.textContent = slider.value;
        }

        function handleRatioChange() {
            const ratio = document.getElementById('videoRatio').value;
            const ratioNames = {
                '16:9': '16:9 æ¨ªå±ï¼ˆ1920Ã—1080ï¼‰',
                '9:16': '9:16 ç«–å±ï¼ˆ1080Ã—1920ï¼‰',
                '1:1': '1:1 æ–¹å½¢ï¼ˆ1080Ã—1080ï¼‰',
                '4:3': '4:3 æ ‡å‡†ï¼ˆ1440Ã—1080ï¼‰'
            };
            addLog(`ğŸ“ è§†é¢‘æ¯”ä¾‹å·²åˆ‡æ¢åˆ°ï¼š${ratioNames[ratio]}`);
        }

        function handleAlignmentChange() {
            const alignment = document.getElementById('alignment').value;
            const alignmentNames = {
                '1': 'å·¦ä¸‹', '2': 'åº•éƒ¨å±…ä¸­', '3': 'å³ä¸‹',
                '4': 'å·¦ä¸­', '5': 'å±å¹•ä¸­å¤®', '6': 'å³ä¸­',
                '7': 'å·¦ä¸Š', '8': 'é¡¶éƒ¨å±…ä¸­', '9': 'å³ä¸Š'
            };

            if (alignment === '5') {
                // ä¸­å¤®å¯¹é½æ—¶ï¼Œæç¤ºå¯ä»¥å°†è¾¹è·è®¾ä¸º0
                addLog(`ğŸ“ ä½ç½®å·²åˆ‡æ¢åˆ°ï¼š${alignmentNames[alignment]}ï¼ˆå»ºè®®è¾¹è·è®¾ä¸º0ï¼‰`);
            } else if (['7', '8', '9'].includes(alignment)) {
                // é¡¶éƒ¨å¯¹é½æ—¶ï¼Œæç¤ºè¾¹è·æ˜¯ä»é¡¶éƒ¨è®¡ç®—
                addLog(`ğŸ“ ä½ç½®å·²åˆ‡æ¢åˆ°ï¼š${alignmentNames[alignment]}ï¼ˆè¾¹è·ä»é¡¶éƒ¨è®¡ç®—ï¼‰`);
            } else {
                addLog(`ğŸ“ ä½ç½®å·²åˆ‡æ¢åˆ°ï¼š${alignmentNames[alignment]}`);
            }
        }

        // å­—ä½“é…ç½®ç›¸å…³å‡½æ•°
        function handleFontModeChange() {
            const mode = document.getElementById('fontMode').value;
            const fontNameSection = document.getElementById('fontNameSection');
            const fontFileSection = document.getElementById('fontFileSection');
            const fontModeHint = document.getElementById('fontModeHint');

            // éšè—æ‰€æœ‰section
            fontNameSection.style.display = 'none';
            fontFileSection.style.display = 'none';

            // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºå¯¹åº”section
            if (mode === 'name') {
                fontNameSection.style.display = 'block';
                fontModeHint.innerHTML = 'ğŸ“ æ‰‹åŠ¨è¾“å…¥ç³»ç»Ÿå·²å®‰è£…çš„å­—ä½“åç§°ï¼Œå¯æŒ‡å®šå¤šä¸ªå­—ä½“ä½œä¸ºå›é€€ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰';
                addLog('ğŸ”¤ åˆ‡æ¢åˆ°æ‰‹åŠ¨å­—ä½“åç§°æ¨¡å¼');
            } else if (mode === 'file') {
                fontFileSection.style.display = 'block';
                fontModeHint.innerHTML = 'ğŸ“‚ ä½¿ç”¨fontsç›®å½•ä¸­çš„å­—ä½“æ–‡ä»¶ï¼Œæ¨èä¸‹è½½Noto Sansç³»åˆ—å­—ä½“';
                addLog('ğŸ”¤ åˆ‡æ¢åˆ°å­—ä½“æ–‡ä»¶æ¨¡å¼');
            } else {
                fontModeHint.innerHTML = 'âœ¨ è‡ªåŠ¨æ¨¡å¼ä¼šä¸ºæ¯ç§è¯­è¨€é€‰æ‹©æœ€åˆé€‚çš„å­—ä½“ï¼Œè§£å†³å°è¯­ç§å­—ä½“ä¸¢å¤±é—®é¢˜';
                addLog('ğŸ”¤ åˆ‡æ¢åˆ°è‡ªåŠ¨å­—ä½“æ˜ å°„æ¨¡å¼ï¼ˆæ¨èï¼‰');
            }
        }

        async function refreshFontFiles() {
            try {
                const response = await fetch('/api/font_files');
                const data = await response.json();

                const fontFileSelect = document.getElementById('fontFile');
                const fontFileHint = document.getElementById('fontFileHint');

                if (data.success && data.fonts && data.fonts.length > 0) {
                    fontFileSelect.innerHTML = '<option value="">ä»fontsç›®å½•é€‰æ‹©...</option>';
                    data.fonts.forEach(font => {
                        const option = document.createElement('option');
                        option.value = font.path;
                        option.textContent = font.name;
                        fontFileSelect.appendChild(option);
                    });
                    fontFileHint.innerHTML = `âœ… æ‰¾åˆ° ${data.count} ä¸ªå­—ä½“æ–‡ä»¶`;
                    fontFileHint.style.color = '#000000';
                } else {
                    fontFileSelect.innerHTML = '<option value="">æœªæ‰¾åˆ°å­—ä½“æ–‡ä»¶</option>';
                    fontFileHint.innerHTML = 'âš ï¸ fontsç›®å½•ä¸ºç©ºï¼Œ<a href="https://fonts.google.com/noto" target="_blank" style="color: #000; text-decoration: underline;">ç‚¹å‡»ä¸‹è½½Noto Sanså­—ä½“</a>';
                    fontFileHint.style.color = '#666666';
                }
            } catch (error) {
                console.error('åŠ è½½å­—ä½“æ–‡ä»¶å¤±è´¥:', error);
                addLog('âš ï¸ å­—ä½“æ–‡ä»¶åˆ—è¡¨åŠ è½½å¤±è´¥');
            }
        }

        // è·¯å¾„éªŒè¯é€»è¾‘
        function validatePathFormat(path) {
            const trimmed = path.trim();
            if (!trimmed) return { valid: false, message: 'è·¯å¾„ä¸èƒ½ä¸ºç©º' };
            if (trimmed !== path) return { valid: false, message: 'è·¯å¾„å‰åä¸èƒ½åŒ…å«ç©ºæ ¼' };
            if (trimmed.includes('"') || trimmed.includes("'")) return { valid: false, message: 'è·¯å¾„ä¸èƒ½åŒ…å«å¼•å·' };
            if (/\s{2,}/.test(trimmed)) return { valid: false, message: 'è·¯å¾„æ ¼å¼é”™è¯¯ï¼šè¿ç»­ç©ºæ ¼' };
            
            // ç®€å•æ”¾å®½éªŒè¯ï¼Œå…¼å®¹æ›´å¤šè·¯å¾„æ ¼å¼ï¼Œä¸»è¦ä¾èµ–åç«¯æ£€æŸ¥
            if (trimmed.length > 0) return { valid: true, message: '' };
            
            return { valid: false, message: 'æ— æ•ˆçš„è·¯å¾„æ ¼å¼' };
        }

        function handlePathInput(type) {
            const input = document.getElementById(`${type}Folder`);
            const button = document.getElementById(`validate${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);
            const message = document.getElementById(`${type}FolderMsg`);
            const path = input.value;

            input.classList.remove('valid', 'invalid');
            validationState[type] = false;

            if (!path) {
                button.disabled = true;
                message.textContent = '';
                message.className = 'validation-message';
                updateStartButton();
                return;
            }

            const formatCheck = validatePathFormat(path);
            if (!formatCheck.valid) {
                input.classList.add('invalid');
                message.innerHTML = `<span style="color:var(--warning)">âš </span> ${formatCheck.message}`;
                message.className = 'validation-message warning';
            } else {
                message.textContent = '';
                message.className = 'validation-message';
            }
            // å§‹ç»ˆå…è®¸éªŒè¯ï¼Œå› ä¸ºä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•è¿é€šæ€§
            button.disabled = false;
            updateStartButton();
        }

        async function validateFolder(type) {
            const input = document.getElementById(`${type}Folder`);
            const message = document.getElementById(`${type}FolderMsg`);
            const path = input.value.trim();

            if (!path) return;

            message.innerHTML = '<span class="loading-dots">æ­£åœ¨éªŒè¯</span>';
            message.className = 'validation-message';

            try {
                const response = await fetch('/api/validate_folder', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ folder_path: path, folder_type: type })
                });

                const data = await response.json();

                if (data.valid) {
                    input.classList.remove('invalid');
                    input.classList.add('valid');
                    message.innerHTML = `<span>âœ“</span> ${data.message}`;
                    message.className = 'validation-message success';
                    validationState[type] = true;
                    addLog(`ğŸ“ ${type === 'video' ? 'è§†é¢‘' : type === 'subtitle' ? 'å­—å¹•' : 'è¾“å‡º'}è·¯å¾„å·²ç¡®è®¤`);

                    if (type === 'subtitle' && data.languages) {
                        const container = document.getElementById('languageContainer');
                        container.innerHTML = '';
                        data.languages.forEach(lang => {
                            const tag = document.createElement('span');
                            tag.className = 'tag';
                            tag.textContent = lang;
                            container.appendChild(tag);
                        });
                    }
                } else {
                    input.classList.remove('valid');
                    input.classList.add('invalid');
                    message.innerHTML = `<span>âœ—</span> ${data.message}`;
                    message.className = 'validation-message error';
                    validationState[type] = false;
                }
            } catch (error) {
                input.classList.add('invalid');
                message.innerHTML = `<span>âœ—</span> éªŒè¯è¯·æ±‚å¤±è´¥`;
                message.className = 'validation-message error';
                validationState[type] = false;
            }

            updateStartButton();
        }

        function updateStartButton() {
            const startBtn = document.getElementById('startBtn');
            const allValid = validationState.video && validationState.subtitle && validationState.output;
            startBtn.disabled = !allValid;
        }

        async function startMerge() {
            if (!validationState.video || !validationState.subtitle || !validationState.output) {
                alert('è¯·å…ˆå®Œæˆæ‰€æœ‰è·¯å¾„éªŒè¯');
                return;
            }

            const videoFolder = document.getElementById('videoFolder').value.trim();
            const subtitleFolder = document.getElementById('subtitleFolder').value.trim();
            const outputFolder = document.getElementById('outputFolder').value.trim();

            // è·å–GPUè®¾ç½®
            const useGpu = document.getElementById('useGpu').checked;
            const gpuType = document.getElementById('gpuType').value;

            // è·å–å­—å¹•æ ·å¼é…ç½®
            let subtitleStyle = null;
            const useCustomStyle = document.getElementById('useCustomStyle').checked;
            if (useCustomStyle) {
                subtitleStyle = {
                    font_size: document.getElementById('fontSize').value,
                    margin_v: document.getElementById('marginV').value,
                    alignment: document.getElementById('alignment').value
                };

                // å­—ä½“é…ç½®
                const fontMode = document.getElementById('fontMode').value;

                if (fontMode === 'auto') {
                    // è‡ªåŠ¨æ˜ å°„æ¨¡å¼
                    subtitleStyle.auto_font = true;
                    addLog('ğŸ¨ å·²å¯ç”¨æ™ºèƒ½å­—ä½“æ˜ å°„ï¼Œå°†ä¸ºæ¯ç§è¯­è¨€è‡ªåŠ¨é€‰æ‹©æœ€ä½³å­—ä½“');
                } else if (fontMode === 'name') {
                    // æ‰‹åŠ¨å­—ä½“åç§°æ¨¡å¼
                    const fontName = document.getElementById('fontName').value.trim();
                    if (fontName) {
                        subtitleStyle.font_name = fontName;
                        subtitleStyle.auto_font = false;
                        addLog(`ğŸ”¤ ä½¿ç”¨è‡ªå®šä¹‰å­—ä½“: ${fontName}`);
                    } else {
                        subtitleStyle.auto_font = true; // å¦‚æœæ²¡å¡«ï¼Œå›é€€åˆ°è‡ªåŠ¨æ¨¡å¼
                    }
                } else if (fontMode === 'file') {
                    // å­—ä½“æ–‡ä»¶æ¨¡å¼
                    const fontFile = document.getElementById('fontFile').value;
                    if (fontFile) {
                        subtitleStyle.font_file = fontFile;
                        subtitleStyle.auto_font = false;
                        addLog(`ğŸ“‚ ä½¿ç”¨å­—ä½“æ–‡ä»¶: ${fontFile.split(/[/\\]/).pop()}`);
                    } else {
                        alert('è¯·é€‰æ‹©ä¸€ä¸ªå­—ä½“æ–‡ä»¶');
                        return;
                    }
                }

                // å¯é€‰é¡¹ï¼šè½®å»“å’Œé˜´å½±
                const outline = document.getElementById('outline').value;
                const shadow = document.getElementById('shadow').value;
                if (outline && outline !== '0') {
                    subtitleStyle.outline = outline;
                }
                if (shadow && shadow !== '0') {
                    subtitleStyle.shadow = shadow;
                }
            }

            if (!confirm('ç¡®å®šè¦å¼€å§‹æ‰¹é‡åˆæˆä»»åŠ¡å—ï¼Ÿ')) return;

            document.getElementById('logBox').innerHTML = '';

            try {
                const response = await fetch('/api/start_merge', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        video_folder: videoFolder,
                        subtitle_folder: subtitleFolder,
                        output_folder: outputFolder,
                        use_gpu: useGpu,
                        gpu_type: gpuType,
                        subtitle_style: subtitleStyle
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addLog('ğŸš€ ä»»åŠ¡é˜Ÿåˆ—å·²å¯åŠ¨...');
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'block';
                    updateStatus('processing');
                    
                    if (statusCheckInterval) clearInterval(statusCheckInterval);
                    statusCheckInterval = setInterval(checkStatus, 1000);
                } else {
                    alert('å¯åŠ¨å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('ç³»ç»Ÿé”™è¯¯: ' + error.message);
            }
        }

        async function stopMerge() {
            if (!confirm('ç¡®å®šè¦ç»ˆæ­¢å½“å‰ä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                const response = await fetch('/api/stop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                if (data.success) {
                    addLog('ğŸ›‘ æ­£åœ¨è¯·æ±‚ç»ˆæ­¢ä»»åŠ¡...');
                    document.getElementById('stopBtn').disabled = true;
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                const progress = data.total > 0 ? (data.progress / data.total * 100).toFixed(1) : 0;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressBarText').textContent = `${Math.round(progress)}%`;
                document.getElementById('progressText').textContent = `${data.progress} / ${data.total}`;

                const currentTaskEl = document.getElementById('currentTask');
                if (data.current_task) {
                    currentTaskEl.style.display = 'block';
                    document.getElementById('currentTaskText').textContent = data.current_task;
                } else {
                    currentTaskEl.style.display = 'none';
                }

                if (data.logs && data.logs.length > 0) {
                    const logBox = document.getElementById('logBox');
                    const currentLogCount = logBox.children.length;
                    if (data.logs.length > currentLogCount) {
                        for (let i = currentLogCount; i < data.logs.length; i++) {
                            addLog(data.logs[i], false);
                        }
                        logBox.scrollTop = logBox.scrollHeight;
                    }
                }

                if (data.completed) {
                    finishTask('completed', 'ğŸ‰ æ‰€æœ‰ä»»åŠ¡å·²å¤„ç†å®Œæˆï¼');
                } else if (data.error) {
                    const isAborted = data.error.includes('ç»ˆæ­¢');
                    finishTask('error', isAborted ? 'âš ï¸ ä»»åŠ¡å·²ç»ˆæ­¢' : `âŒ é”™è¯¯: ${data.error}`);
                } else if (data.is_processing) {
                    updateStatus('processing');
                }
            } catch (error) {
                console.error('çŠ¶æ€åŒæ­¥å¤±è´¥', error);
            }
        }

        function finishTask(status, message) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('stopBtn').disabled = false;
            updateStatus(status);
            if(message) alert(message);
        }

        function addLog(message, scroll = true) {
            const logBox = document.getElementById('logBox');
            const logLine = document.createElement('div');
            logLine.className = 'log-line';

            if (message.includes('âœ“') || message.includes('å®Œæˆ') || message.includes('æˆåŠŸ')) {
                logLine.style.color = '#4ade80';
            } else if (message.includes('âœ—') || message.includes('å¤±è´¥') || message.includes('é”™è¯¯')) {
                logLine.style.color = '#f87171';
            } else if (message.includes('âš ') || message.includes('è·³è¿‡')) {
                logLine.style.color = '#fbbf24';
            } else if (message.includes('ğŸš€') || message.includes('===')) {
                logLine.style.color = '#60a5fa';
                logLine.style.fontWeight = 'bold';
            }

            logLine.textContent = message;
            logBox.appendChild(logLine);

            if (scroll) logBox.scrollTop = logBox.scrollHeight;
        }

        function updateStatus(status) {
            const badge = document.getElementById('statusBadge');
            badge.className = 'status-badge';
            
            switch(status) {
                case 'processing':
                    badge.classList.add('status-processing');
                    badge.innerHTML = '<span class="loading-dots">å¤„ç†ä¸­</span>';
                    break;
                case 'completed':
                    badge.classList.add('status-completed');
                    badge.textContent = 'å®Œæˆ';
                    break;
                case 'error':
                    badge.classList.add('status-error');
                    badge.textContent = 'å¼‚å¸¸';
                    break;
                default:
                    badge.classList.add('status-idle');
                    badge.textContent = 'å¾…æœº';
            }
        }
    </script>
</body>
</html>